<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Escala Policial</title>

<style>
*{box-sizing:border-box}

body{
 margin:0;
 font-family:Arial, sans-serif;
 background:#121212;
 color:#fff;
 padding-top:env(safe-area-inset-top);
}

header{
 background:#0d47a1;
 padding:16px;
 text-align:center;
 font-size:20px;
 font-weight:bold;
 margin-top:10px;
}

.top-controls{
 display:flex;
 gap:8px;
 padding:12px;
 flex-wrap:wrap;
}

select,input,button{
 padding:8px;
 border-radius:6px;
 border:none;
 font-size:14px;
}

button{
 background:#1976d2;
 color:#fff;
}

table{
 width:100%;
 border-collapse:collapse;
}

th,td{
 border:1px solid #333;
 padding:6px;
 text-align:center;
}

th{
 background:#1e1e1e;
}

input.horario{
 width:100%;
 background:#1e1e1e;
 color:#fff;
 border:1px solid #444;
 padding:6px;
}

.footer-box{
 margin:16px;
 padding:12px;
 background:#1e1e1e;
 border-radius:8px;
}

.footer-box h3{
 margin-top:0;
 font-size:16px;
 color:#90caf9;
}

.legend{
 font-size:13px;
 line-height:1.6;
}
</style>
</head>

<body>

<header>ðŸ“‹ Escala Policial</header>

<div class="top-controls">
 <select id="mes"></select>
 <input type="number" id="ano" value="2025">
 <button onclick="gerarDias()">Gerar</button>
 <button onclick="gerarPDF()">PDF</button>
</div>

<table>
<thead>
<tr>
 <th>Dia</th>
 <th>Semana</th>
 <th>Turno / Legenda</th>
 <th>HorÃ¡rio</th>
 <th>Horas</th>
</tr>
</thead>
<tbody id="dias"></tbody>
</table>

<div class="footer-box">
 <h3>ðŸ“Š Resumo Mensal</h3>
 <p><b>Carga HorÃ¡ria:</b> <span id="totalHoras">0</span> h</p>
 <p><b>Hora Extra:</b> <span id="horaExtra">0</span> h</p>
 <p><b>PecÃºnia Extra:</b> R$ <span id="valorExtra">0,00</span></p>
</div>

<div class="footer-box">
 <h3>ðŸ“Œ Legendas</h3>
 <div class="legend">
 FER â€“ FÃ©rias<br>
 FOL â€“ Folga<br>
 APR â€“ ApresentaÃ§Ã£o<br>
 TRÃ‚ â€“ TrÃ¢nsito<br>
 INS â€“ InstruÃ§Ã£o<br>
 LUT â€“ Luto<br>
 NUP â€“ NÃºcleo Psicossocial<br>
 DIM â€“ DiminuiÃ§Ã£o<br>
 RSP â€“ Resposta<br>
 TAF â€“ Teste AptidÃ£o FÃ­sica<br>
 SAU â€“ SaÃºde
 </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const STORAGE_KEY="escala_policial_dados";

const meses=["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho",
"Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

const mesSelect=document.getElementById("mes");
meses.forEach((m,i)=>{
 let o=document.createElement("option");
 o.value=i; o.text=m;
 mesSelect.add(o);
});

const turnosHoras={"1":6,"2":6,"3":6,"4":6,"23":12,"34":12,"41":12};
const horariosPadrao={
 "1":"00h Ã s 06h","2":"06h Ã s 12h","3":"12h Ã s 18h","4":"18h Ã s 00h",
 "23":"06h Ã s 18h","34":"12h Ã s 00h","41":"18h Ã s 06h"
};
const legendas=["FER","FOL","APR","TRÃ‚","INS","LUT","NUP","DIM","RSP","TAF","SAU"];

function salvarDados(){
 const dados={
  mes:mesSelect.value,
  ano:document.getElementById("ano").value,
  linhas:[...document.querySelectorAll("#dias tr")].map(tr=>{
   return {
    turno:tr.children[2].querySelector("select").value,
    horario:tr.children[3].querySelector("input").value,
    horas:tr.children[4].innerText
   }
  })
 };
 localStorage.setItem(STORAGE_KEY,JSON.stringify(dados));
}

function carregarDados(){
 const dados=JSON.parse(localStorage.getItem(STORAGE_KEY));
 if(!dados) return;

 mesSelect.value=dados.mes;
 document.getElementById("ano").value=dados.ano;
 gerarDias();

 document.querySelectorAll("#dias tr").forEach((tr,i)=>{
  if(!dados.linhas[i]) return;
  tr.children[2].querySelector("select").value=dados.linhas[i].turno;
  tr.children[3].querySelector("input").value=dados.linhas[i].horario;
  tr.children[4].innerText=dados.linhas[i].horas;
 });
 calcularTotais();
}

function gerarDias(){
 const tbody=document.getElementById("dias");
 tbody.innerHTML="";
 const ano=document.getElementById("ano").value;
 const mes=mesSelect.value;
 const totalDias=new Date(ano,parseInt(mes)+1,0).getDate();

 for(let d=1;d<=totalDias;d++){
  const data=new Date(ano,mes,d);
  const semana=["Dom","Seg","Ter","Qua","Qui","Sex","SÃ¡b"][data.getDay()];
  let options=`<option></option>
  <option>1</option><option>2</option><option>3</option><option>4</option>
  <option>23</option><option>34</option><option>41</option>`;
  legendas.forEach(l=>options+=`<option>${l}</option>`);

  const tr=document.createElement("tr");
  tr.innerHTML=`
   <td>${d}</td>
   <td>${semana}</td>
   <td><select onchange="atualizarLinha(this);salvarDados()">${options}</select></td>
   <td><input class="horario" oninput="calcularHorasManual(this);salvarDados()"></td>
   <td class="horas">0</td>`;
  tbody.appendChild(tr);
 }
 calcularTotais();
 salvarDados();
}

function atualizarLinha(select){
 const linha=select.closest("tr");
 const campoHorario=linha.querySelector(".horario");
 const campoHoras=linha.querySelector(".horas");
 const valor=select.value;

 if(turnosHoras[valor]){
  campoHorario.value=horariosPadrao[valor];
  campoHoras.innerText=turnosHoras[valor];
 }
 calcularTotais();
}

function calcularHorasManual(input){
 const linha=input.closest("tr");
 const campoHoras=linha.querySelector(".horas");
 const m=input.value.match(/(\d{1,2})h?\s*Ã s\s*(\d{1,2})h?/i);
 if(!m){campoHoras.innerText=0;return;}

 let ini=parseInt(m[1]),fim=parseInt(m[2]);
 campoHoras.innerText=fim>ini?fim-ini:(24-ini)+fim;
 calcularTotais();
}

function calcularTotais(){
 let total=0;
 document.querySelectorAll(".horas").forEach(h=>total+=parseInt(h.innerText)||0);
 const dias=new Date(document.getElementById("ano").value,parseInt(mesSelect.value)+1,0).getDate();
 const limite=dias===31?177:171;
 const extra=Math.max(0,total-limite);
 document.getElementById("totalHoras").innerText=total;
 document.getElementById("horaExtra").innerText=extra;
 document.getElementById("valorExtra").innerText=(extra*46.37).toFixed(2).replace(".",",");
}

function gerarPDF(){
 const {jsPDF}=window.jspdf;
 const pdf=new jsPDF();
 pdf.text("RELATÃ“RIO DE ESCALA POLICIAL",105,15,{align:"center"});
 let y=25;
 document.querySelectorAll("#dias tr").forEach(tr=>{
  if(y>280){pdf.addPage();y=20;}
  const c=tr.children;
  pdf.text(`${c[0].innerText} (${c[1].innerText}) - ${c[2].innerText} - ${c[4].innerText}h`,10,y);
  y+=6;
 });
 pdf.save("escala_policial.pdf");
}

window.onload=carregarDados;
</script>

</body>
</html>
